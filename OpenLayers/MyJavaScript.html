<!doctype html>
<html lang="en">
  <head>
       <style>
	   
	   body {
	   margin: 2px;
	   padding: 2px;
	   }
	   .header {
	   display:block;
	   width:100%;
	   height:70px;
	   border: 1px solid;
	   background-color: #f1f0f0;
	   }
	   
	   .logo{
	   position:relative;
	   left:43%;
	   }
	   
	   
	   .center{
	   width:79.7%;
	   float:left;
	   }
	   .left {
	   background-color:#f1f0f0;
	   border:1px solid;
	   overflow:hidden;
	   height:900px;
	   width: 10%;
	   display:block;
	   float:left;
	   }
	   
	   .right {overflow:hidden;
	    background-color:#f1f0f0;
	   border:1px solid;
	   height:900px;
	   	   width: 10%;
	   display:block;
	   float:left;
	   }
      	 .map {
        height: 900px;
        width: 100%;
      }
	.svg {
		position:absolute;
		top:75px;
		    left: 200px;
        pointer-events:none;
	}
	.scales {
	display:block;
	}
	
	
	#symbols {
	    transform : scale(0.7);
		display : none;
					}
					
	.signBeyz{
	display:block;
	}
	
	#logo_text{
	height: 70px;
    line-height: 22px;
    font-size: 25px;
	}
		
.signSymbol{
transform: "scale (1.5,1.5)";
}     	

.pointSign{
}

.leftToolBar{
position:absolute;
left:20px;
top:20px;
mergin: 10px;
}

.leftTool{
    border: 2px solid;
    border-radius: 5px;
cursor:pointer;
color: #989898;
margin:7px;
}

.rightToolBar{
position:absolute;
right:20px;
top:20px;
mergin: 10px;
}
.spanBlock{
display:block;
}

#bbox {
pointer-events:auto;
}

    </style>
<script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
<link rel="stylesheet" href="./font-awesome/css/font-awesome.min.css">

<title>OpenLayers example</title>
  </head>

<body>
<div class = "header">
<div class = "leftToolBar">
<i class="leftTool fa fa-user-circle fa-2x" aria-hidden="true" onclick = "alert()"></i>
<i class="leftTool fa fa-address-book-o fa-2x" aria-hidden="true"></i>
<i class="leftTool fa fa-info-circle fa-2x" aria-hidden="true"></i>
</div>



<div class = "logo">
<img src="./glob.png" style="width:70px; float:left;"/>
<div id = "logo_text">
<div>Редактор</div>
<div>Оперативной</div>
<div>Обстановки</div>
</div>
</div>

<div class = "rightToolBar">
<i class="leftTool fa fa-user-circle fa-2x" aria-hidden="true" onclick = "serialize()"></i>
<i class="leftTool fa fa-address-book-o fa-2x" aria-hidden="true" onclick = "ParseJson()"></i>
<i class="leftTool fa fa-info-circle fa-2x" aria-hidden="true"></i>
</div>
</div>
    <div class = "left">
	<span><b>Дерево слоев:</b></span>
<div class = "LayersVisible">	
	<input type="checkbox" id="one" name="scales" onchange="toggleCheckbox(this)"checked>
  <label for="scales">Слой красных</label>
 </div> 
 <div class = "LayersVisible">	
   <input type="checkbox" id="two" name="scales" onchange="toggleCheckbox(this)" checked>
  <label for="scales">Слой зеленых</label> 
  
         
</div>

<div class = "LayersVisible">
<input type="checkbox" id="three" name="scales" onchange="toggleCheckbox(this)" checked >
  <label for="scales">Слой серых</label>
	</div>
	
	
	<span class = "spanBlock" ><b>Дерево Знаков:</b></span>
	<span class = "spanBlock">Морской флот:</span>
	<span class = "spanBlock">Наземные войста:</span>
	<span class = "spanBlock">Инжинерные войска:</span>
	<span class = "spanBlock">Стройбат:</span>
	
	</div> 
	<div class = "center">
		<div id="map" class="map">
		
	</div>
	

	
	<div id="ToolsPanel"></div>

	

	<svg id="symbols">
	<symbol class = "signSymbol" id="sign1" stroke="red" pointX="0" pointY="-140">
			
			<line x1="50" y1="75" x2="0" y2="50"  stroke-width="3"></line>
			<line x1="0" y1="140" x2="0" y2="50" stroke-width="7"></line>
			<line x1="0" y1="100" x2="50" y2="75" stroke-width="3"></line>
			
	</symbol>
	
	<symbol class = "signSymbol" id="sign2" stroke="blue" pointX="-50" pointY="-140">
			
			<line x1="50" y1="50" x2="0" y2="75" stroke-width="3"></line>
			<line x1="50" y1="140" x2="50" y2="50" stroke-width="3"></line>
			<line x1="0" y1="75" x2="50" y2="100" stroke-width="3"></line>
			
	</symbol>
	
	<symbol class = "signSymbol" id="sign3" stroke="grey" pointX="-50" pointY="-140">
			
			<line x1="150" y1="50" x2="0" y2="75" stroke-width="3"></line>
		<line x1="50" y1="140" x2="50" y2="50" stroke-width="3"></line>
			<line x1="0" y1="75" x2="50" y2="100" stroke-width="3"></line>
			
	</symbol>
		</svg>
	
	 
	
  </div>
  
  <div class = "right">
  <span><b>Библиотека знаков:</b></span>
  <button class = "signBeyz" id = "button1" onclick="sign1Add()">Красный знак</button>
	<button class = "signBeyz" id = "button2" onclick="sign2Add()">Зеленый знак</button>
	<button class = "signBeyz" id = "button3" onclick="sign3Add()">Серый знак</button>
		<button class = "signBeyz" id = "button4" onclick="sign4Add()">Линия</button>
		
		</div>
	</body>


<script>


var createSignSym = createSignSymbols();


function createSignSymbols(){

var PointSymbolsArray=[];
var signSymbols = document.getElementsByClassName("signSymbol");

for (var q=0; q<signSymbols.length; q++){
var signSymbolsAtr = signSymbols[q];

var Obj = {}

Obj['name'] = signSymbolsAtr.getAttribute('id');
Obj['pointx'] = signSymbolsAtr.getAttribute('pointx');
Obj['pointy'] = signSymbolsAtr.getAttribute('pointy');


var signSymbolsAtr = signSymbols[q].children;
console.log(signSymbolsAtr);


for (var j=0; j<signSymbolsAtr.length; j++){
Obj[j] = [signSymbolsAtr[j].attributes.x1.value,signSymbolsAtr[j].attributes.y1.value,signSymbolsAtr[j].attributes.x2.value,signSymbolsAtr[j].attributes.y2.value];

}

console.log(Obj);
PointSymbolsArray.push(Obj);
console.log(PointSymbolsArray);
}
return PointSymbolsArray;

}


function getSignSymbols(){
console.log(createSignSym);

for (var j=0; j<createSignSym.length; j++){
	var editElement = document.getElementById(createSignSym[j]['name']);
	editElement.setAttribute('pointx', createSignSym[j].pointx);
	editElement.setAttribute('pointy', createSignSym[j].pointy);
		for (var q=0; q<editElement.children.length; q++){
			var editNode = editElement.children[q].attributes;
			var valueNode = createSignSym[j][q];
				for (var i=0; i<valueNode.length; i++){
					editNode[i].value = valueNode[i]; 
				}
		}
}

/*

var editNode = editElement.children[1].attributes;
var valueNode = createSignSym[0][1];

for (var i=0; i<valueNode.length; i++){
editNode[i].value = valueNode[i]; 
}
var editNode = editElement.children[2].attributes;
var valueNode = createSignSym[0][2];

for (var i=0; i<valueNode.length; i++){
editNode[i].value = valueNode[i]; 
}

*/
console.log(editNode);
console.log(valueNode);

}




function toggleCheckbox(checkBox){
	var layer = document.getElementById("layer" + checkBox.getAttribute('id'));
	if (!checkBox.checked)layer.style.display="none";
	if (checkBox.checked)layer.style.display="";
}

function sign1Add(){
	var t = new PointSign("sign1", "red")
	Conteiner.setPointSign(t);
}

function sign2Add(){
	Conteiner2.setPointSign(new PointSign("sign2", "green"));
}

function sign3Add(){
	Conteiner3.setPointSign(new PointSign("sign3", "green"));
}

function sign4Add(){
	Conteiner.setLineSign(new LineSign("line1", "red"));
}






	var lastFocus = null;

      var map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          })
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([37.41, 8.82]),
          zoom: 5
        })
      });
	var oldEvt=map.focus_;


function svgConteiner(width, height, id){
	var center = document.getElementsByClassName("center");
	var cxtConteiner = this;
	this.resolution = map.getView().getZoom();
	this.width = width;
	this.height = height;
	this.id=id;
	this.Editable = false;
	this.OverBox =false;

	this.svgCont = document.createElementNS('http://www.w3.org/2000/svg','svg');
	this.svgCont.setAttribute("width", width+"px");
	this.svgCont.setAttribute("height", height+"px");
	this.svgCont.setAttribute("id",this.id);
	this.svgCont.setAttribute("class","svg");
	center[0].appendChild(this.svgCont);




this.sizeUpdate2 = function(){
	var zoom = map.getView().getZoom();
	var signCollection = document.getElementsByClassName("signSymbol");
	
	var ExtendArray = {
		0:0.3,
		1:0.3,
		2:0.3,
		3:0.3,
		4:0.4,
		5:0.5,
		6:0.6,
		7:0.7,
		8:0.7,
		9:0.7,
		10:0.7,
		11:0.7,
		12:0.7,
		13:0.7,
		14:0.7,
		15:0.7,
		16:0.7,
		17:0.6,
		18:0.6,
		19:0.6,
		20:0.6,
		21:0.6,
		22:0.6,
		23:0.6,
		24:0.6,
		25:0.6
	}	

	
	for (var i=0; i<signCollection.length; i++){
	
			if (Number.isInteger(zoom) && Conteiner.resolution){
			var smewenieX = signCollection[i].getAttribute('pointx');
				var smewenieY = signCollection[i].getAttribute('pointy');
				signCollection[i].setAttribute('pointx', smewenieX *ExtendArray[zoom]);
				signCollection[i].setAttribute('pointy', smewenieY *ExtendArray[zoom]);
				var t1 = signCollection[i].children;
				var t2 = t1[0].attributes;
				t2[0].value = t2[0].value *ExtendArray[zoom]; 
				t2[1].value = t2[1].value * ExtendArray[zoom]; 
				t2[2].value = t2[2].value * ExtendArray[zoom]; 
				t2[3].value = t2[3].value * ExtendArray[zoom]; 
				var t3 = t1[1].attributes;
				t3[0].value = t3[0].value * ExtendArray[zoom];                 
				t3[1].value = t3[1].value * ExtendArray[zoom]; 
				t3[2].value = t3[2].value * ExtendArray[zoom]; 
				t3[3].value = t3[3].value * ExtendArray[zoom]; 
				var t4 = t1[2].attributes;
				t4[0].value = t4[0].value * ExtendArray[zoom]; 
				t4[1].value = t4[1].value * ExtendArray[zoom]; 
				t4[2].value = t4[2].value * ExtendArray[zoom]; 
				t4[3].value = t4[3].value * ExtendArray[zoom]; 
				console.log(t2);
			}

	}
	Conteiner.resolution=zoom;	
} 





this.sizeUpdate = function(){
	var zoom = map.getView().getZoom();
	var signCollection = document.getElementsByClassName("signSymbol");
		for (var i=0; i<signCollection.length; i++){
			if (Number.isInteger(zoom) && Conteiner.resolution > zoom){
				var smewenieX = signCollection[i].getAttribute('pointx');
				var smewenieY = signCollection[i].getAttribute('pointy');
					signCollection[i].setAttribute('pointx', smewenieX *0.8);
					signCollection[i].setAttribute('pointy', smewenieY *0.8);
				var t1 = signCollection[i].children;
    
					 var t2 = t1[0].attributes;
					 t2[0].value = t2[0].value *0.8; 
					 t2[1].value = t2[1].value * 0.8; 
					 t2[2].value = t2[2].value * 0.8; 
					 t2[3].value = t2[3].value * 0.8; 
					 var t3 = t1[1].attributes;
					 t3[0].value = t3[0].value * 0.8;                 
					 t3[1].value = t3[1].value * 0.8; 
					 t3[2].value = t3[2].value * 0.8; 
					 t3[3].value = t3[3].value * 0.8; 
					 var t4 = t1[2].attributes;
					 t4[0].value = t4[0].value * 0.8; 
					 t4[1].value = t4[1].value * 0.8; 
					 t4[2].value = t4[2].value * 0.8; 
					 t4[3].value = t4[3].value * 0.8; 
	 
			}else if (Number.isInteger(zoom) && Conteiner.resolution < zoom){

				var t1 = signCollection[i].children;
				var smewenieX = signCollection[i].getAttribute('pointx');
				var smewenieY = signCollection[i].getAttribute('pointy');
				signCollection[i].setAttribute('pointx', smewenieX *1.25);
				signCollection[i].setAttribute('pointy', smewenieY *1.25);
					
					var t2 = t1[0].attributes;
					 t2[0].value = t2[0].value * 1.25; 
					 t2[1].value = t2[1].value * 1.25; 
					 t2[2].value = t2[2].value * 1.25; 
					 t2[3].value = t2[3].value * 1.25; 
					 var t3 = t1[1].attributes;
					 t3[0].value = t3[0].value * 1.25;                 
					 t3[1].value = t3[1].value * 1.25; 
					 t3[2].value = t3[2].value * 1.25; 
					 t3[3].value = t3[3].value * 1.25; 
					 var t4 = t1[2].attributes;
					 t4[0].value = t4[0].value * 1.25; 
					 t4[1].value = t4[1].value * 1.25; 
					 t4[2].value = t4[2].value * 1.25; 
					 t4[3].value = t4[3].value * 1.25 

			}

	}
Conteiner.resolution=zoom;
}


	
	this.UpdateConteiner = function(){
	 //console.log(SignArray);
	 var massiv = SignArray.ArraySignPosition;
	 
	 	 
	 
	 
	 for (var i=0; i < massiv.length;i++){
	 //console.log(massiv[i]);
	 
	 if (massiv[i] instanceof PointSign){
	 
	 var zoom = map.getView().getZoom();
	 console.log(zoom);
 	 var Smechenie = document.getElementById(massiv[i].classCode);
	 

	xSmechenie = Number(Smechenie.getAttribute("pointx"));
			ySmechenie = Number(Smechenie.getAttribute("pointy"));
		console.log(xSmechenie +" "+ySmechenie);
	 
	  var sss = cxtConteiner.GeoToPointSign(massiv[i]);
	  var signDom = massiv[i].getDom();
	  var mx = sss[0]+xSmechenie;
	  var my = sss[1]+ySmechenie;
	  
	 signDom.setAttribute("x", mx);
	signDom.setAttribute("y", my);	
	if (massiv[i] !=0){ signDom.setAttribute("transform", "translate(" + sss[0] + "," + sss[1] + ") rotate("+massiv[i].rotate+") translate(" + (-sss[0]) + "," + (-sss[1]) + ")")};
			//setAttribute("transform", "translate(" + mx + "," + my + ")");
	
										}
										
	if (massiv[i] instanceof LineSign){
	console.log("ÍÀØÅËÑß");
console.log(massiv[i]);

var kk = massiv[i];
var kj = kk[0];
var kl = kk[1];


console.log("---------------------------------------------------------------");
console.log(kk);
console.log(kj);
console.log(kl);
console.log("---------------------------------------------------------------");


var sss = cxtConteiner.GeoToLineSign(kk);
console.log(sss);
	  var signDom = massiv[i].signDom
	  
	
	
	signDom.setAttribute("x1", sss[0][0]);
	signDom.setAttribute("y1", sss[0][1]);	 
	signDom.setAttribute("x2", sss[1][0]);
	signDom.setAttribute("y2", sss[1][1]);	


	}							
										
										}
	 
	
	 
	 
	}
	
	this.clearALL = function(e){
	var tar = e.target;
		tar = tar.tagName;
	
	
	if (cxtConteiner.Editable && tar != "use")  {
	console.log(tar);
	console.log("ÌÛØÜ ÍÀÆÀÒÀ->ñíÿòèå âûäåëåíèÿ");
		 
			if(cxtConteiner.OverBox){b = document.getElementById('bbox'); b.remove();} 
			cxtConteiner.OverBox=false;
			cxtConteiner.Editable=false;
	document.removeEventListener("click", cxtConteiner.clearALL, false);
	}
	}
	
	this.EditPointSign = function(e, sign){
	
	var signVisual = e.target;
		//tar = tar.tagName;
		console.log(signVisual);
	
		//console.log(sign.getDom());
		
		
		if (!cxtConteiner.Editable && sign instanceof PointSign)  {
	
			console.log("ÌÛØÜ ÍÀÆÀÒÀ->âûäåëåíèå");
			b = document.getElementById('bbox'); 
			//cxtConteiner.BboxToSign(this);
			cxtConteiner.OverBox=true;		
			
			cxtConteiner.Editable=true;
			
			signVisual.onmousedown = function(){
			// PEREMEWENIE
				document.onmousemove = function(e){
				
					b = document.getElementById('bbox'); b.style.display="none";
					
					var Smechenie = document.getElementById(sign.classCode);
					var	xSmechenie = Number(Smechenie.getAttribute("pointx"));
					var	ySmechenie = Number(Smechenie.getAttribute("pointy"));
			
					var sigg = sign.signDom;
					var signX = e.offsetX + xSmechenie;
					var signY = e.offsetY + ySmechenie;
						sigg.setAttribute('x', signX);
						sigg.setAttribute('y', signY);
					
						console.log(sign.signDom);
				
				var t = cxtConteiner.PointSignToGeo([e.offsetX,e.offsetY]);
				console.log(t);
				
				if (sign.rotate !=0) {
				sign.getDom().removeAttribute('transform')
				sign.setX(t[0]);
				sign.setY(t[1]);
            var Smechenie = document.getElementById(sign.classCode);
	   		xSmechenie = Number(Smechenie.getAttribute("pointx"));
			ySmechenie = Number(Smechenie.getAttribute("pointy"));
		console.log(xSmechenie +" "+ySmechenie);
	 
	  var sss = cxtConteiner.GeoToPointSign(sign);
	  var signDom = sign.getDom();
	  var mx = sss[0]+xSmechenie;
	  var my = sss[1]+ySmechenie;
		
	signDom.setAttribute("transform", "translate(" + sss[0] + "," + sss[1] + ") rotate("+sign.rotate+") translate(" + (-sss[0]) + "," + (-sss[1]) + ")");




					
				} else {
				sign.setX(t[0]);
				sign.setY(t[1]);	
					}
					
					console.log('zxczc');
				}
				document.onmouseup = function(){document.onmousemove = null; document.onmouseup = null; signVisual.onmousedown = null;}
			}
			
			
			
			
		document.addEventListener("click", function(e){
		console.log(e.path[0].nodeName);
		
		
		if (e.path[0].nodeName !='circle' ){
		cxtConteiner.clearALL(e);
		}
		
		}, false);
		} 
	
	
	}



	this.BboxToSign = function(sign,cxt){
		// POPITKA BBOX
		var bbox = sign.getBBox();
		//console.log(bbox);
		
		
		this.bboxVisible = document.createElementNS('http://www.w3.org/2000/svg','g');
		this.bboxVisible.setAttribute('id', 'bbox'); //ÁÛËÎ rnd
		this.svgCont.appendChild(this.bboxVisible);
		
		
		var scaleSignVisual = document.createElementNS('http://www.w3.org/2000/svg','circle');
		scaleSignVisual.setAttribute('cx', bbox.x +bbox.width +5 ); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('cy', bbox.y-5 ); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('r',3);
        scaleSignVisual.setAttribute('stroke',2);
		this.bboxVisible.appendChild(scaleSignVisual);
		
			var lineVision = document.createElementNS('http://www.w3.org/2000/svg','line');
		lineVision.setAttribute('x1', bbox.x +bbox.width +5); //ÁÛËÎ rnd
		lineVision.setAttribute('y1', bbox.y-5 ); //ÁÛËÎ rnd
		lineVision.setAttribute('x2', bbox.x -5); //ÁÛËÎ rnd
		lineVision.setAttribute('y2', bbox.y-5 ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke','black' ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke-dasharray','4' ); //ÁÛËÎ rnd

		this.bboxVisible.appendChild(lineVision);
		
		var scaleSignVisual = document.createElementNS('http://www.w3.org/2000/svg','circle');
		scaleSignVisual.setAttribute('cx', bbox.x -5); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('cy', bbox.y-5 ); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('r',3);
        scaleSignVisual.setAttribute('stroke',2);
		this.bboxVisible.appendChild(scaleSignVisual);
		
		
		var lineVision = document.createElementNS('http://www.w3.org/2000/svg','line');
		lineVision.setAttribute('x1', bbox.x -5); //ÁÛËÎ rnd
		lineVision.setAttribute('y1', bbox.y+ bbox.height +5); //ÁÛËÎ rnd
		lineVision.setAttribute('x2', bbox.x -5); //ÁÛËÎ rnd
		lineVision.setAttribute('y2', bbox.y-5 ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke','black' ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke-dasharray','4' ); //ÁÛËÎ rnd

		this.bboxVisible.appendChild(lineVision);
		
		
		
		var scaleSignVisual = document.createElementNS('http://www.w3.org/2000/svg','circle');
		scaleSignVisual.setAttribute('cx', bbox.x -5); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('cy', bbox.y + bbox.height+5); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('r',3);
        scaleSignVisual.setAttribute('stroke',2);
		this.bboxVisible.appendChild(scaleSignVisual);
		
		
		
		var lineVision = document.createElementNS('http://www.w3.org/2000/svg','line');
		lineVision.setAttribute('x1', bbox.x-5); //ÁÛËÎ rnd
		lineVision.setAttribute('y1', bbox.y+ bbox.height +5); //ÁÛËÎ rnd
		lineVision.setAttribute('x2', bbox.x +bbox.width+5); //ÁÛËÎ rnd
		lineVision.setAttribute('y2', bbox.y + bbox.height+5 ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke','black' ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke-dasharray','4' ); //ÁÛËÎ rnd

		this.bboxVisible.appendChild(lineVision);
		
		
		
		
		var scaleSignVisual = document.createElementNS('http://www.w3.org/2000/svg','circle');
		scaleSignVisual.setAttribute('cx', bbox.x +bbox.width+5); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('cy', bbox.y + bbox.height+5 ); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('r',3);
        scaleSignVisual.setAttribute('stroke',2);
		this.bboxVisible.appendChild(scaleSignVisual);
		
				
		var lineVision = document.createElementNS('http://www.w3.org/2000/svg','line');
		lineVision.setAttribute('x1', bbox.x+ bbox.width +5); //ÁÛËÎ rnd
		lineVision.setAttribute('y1', bbox.y); //ÁÛËÎ rnd
		lineVision.setAttribute('x2', bbox.x +bbox.width+5); //ÁÛËÎ rnd
		lineVision.setAttribute('y2', bbox.y + bbox.height+5 ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke','black' ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke-dasharray','4' ); //ÁÛËÎ rnd
		this.bboxVisible.appendChild(lineVision);
		
		var rotateSignVisual = document.createElementNS('http://www.w3.org/2000/svg','circle');
		rotateSignVisual.setAttribute('cx', (bbox.x -5) +bbox.width/2+5); //ÁÛËÎ rnd
		rotateSignVisual.setAttribute('cy', bbox.y-20 ); //ÁÛËÎ rnd
		rotateSignVisual.setAttribute('r',5);
        rotateSignVisual.setAttribute('stroke',2);
		this.bboxVisible.appendChild(rotateSignVisual);
		
		
		
		rotateSignVisual.onmousedown= function(){
		//cxtConteiner.Editable = false ; console.log("ROTATE");
		
		document.onmousemove = function(e)
		{
		

			console.log(e);
		}
		
		rotateSignVisual.onmouseup = function(){
		console.log("Editeble TRUE");
		document.onmousemove = null;
		//cxtConteiner.Editable = true;
		}
				
		}
		

		
		
		
		
		
		var Smechenie = document.getElementById(cxt.classCode);
	   		xSmechenie = Number(Smechenie.getAttribute("pointx"));
			ySmechenie = Number(Smechenie.getAttribute("pointy"));
		console.log(xSmechenie +" "+ySmechenie);
	 
	  var sss = cxtConteiner.GeoToPointSign(cxt);
	  var signDom = this.bboxVisible;
	  var mx = sss[0]+xSmechenie;
	  var my = sss[1]+ySmechenie;
		
	if (cxt.rotate !=0){ signDom.setAttribute("transform", "translate(" + sss[0] + "," + sss[1] + ") rotate("+cxt.rotate+") translate(" + (-sss[0]) + "," + (-sss[1]) + ")")};
		
		
		
		
		
		}





	this.setPointSignWithStorage = function(sign){
	
	var ctx = sign;
	var Smechenie = document.getElementById(sign.classCode);
			xSmechenie = Number(Smechenie.getAttribute("pointx"));
			ySmechenie = Number(Smechenie.getAttribute("pointy"));
		//console.log(xSmechenie +" "+ySmechenie);
	
		
		
		
		var coords = cxtConteiner.GeoToPointSign(sign);
		console.log(coords);
		var coordX = coords[0];
		var coordY = coords[1];
		
		var svgNS = this.svgCont.namespaceURI;
		console.log(sign);
		var signVisual = document.createElementNS('http://www.w3.org/2000/svg','use');
		signVisual.setAttribute('class','pointSign');
		signVisual.setAttribute('href', '#'+ sign.classCode);
		signVisual.setAttribute('x', coordX+xSmechenie); //ÁÛËÎ rnd
		signVisual.setAttribute('y',coordY + ySmechenie); //ÁÛËÎ rnd2-140
		signVisual.style.pointerEvents = "auto";
		signVisual.style.stroke = "green";
		
		
		this.svgCont.appendChild(signVisual);
		sign.signDom = signVisual;
		
		//console.log(signVisual);
		
		
		
		
		signVisual.addEventListener('mouseover', function(){
		if (!cxtConteiner.Editable ){
		console.log(ctx);
		console.log(this);
		 cxtConteiner.BboxToSign(this, ctx);
			}
		});
		
		
		
		signVisual.addEventListener('mouseout', function(){
		
		var b = document.getElementById('bbox');
		console.log(b);
	
		if(b!=null && !cxtConteiner.Editable){b.remove(); console.log("ÌÛØÜ ÂûøËÀ->Ñíÿëè âûäåëåíèå");} 
		});
		
		
		
		
		signVisual.addEventListener('click',   function(e){
				
		cxtConteiner.EditPointSign(e, sign)				
		
		 });
		
	
		

		
			return signVisual;
			
			
		
			
			
			
			}




	this.setPointSign = function(sign){
	
	var ctx = sign;
	var Smechenie = document.getElementById(sign.classCode);
			xSmechenie = Number(Smechenie.getAttribute("pointx"));
			ySmechenie = Number(Smechenie.getAttribute("pointy"));
		console.log(xSmechenie +" "+ySmechenie);
	
		
		var svgNS = this.svgCont.namespaceURI;
		console.log(sign);
		var signVisual = document.createElementNS('http://www.w3.org/2000/svg','use');
		signVisual.setAttribute('class','pointSign');
		signVisual.setAttribute('href', '#'+ sign.classCode);
		signVisual.setAttribute('x', 1000); //ÁÛËÎ rnd
		signVisual.setAttribute('y',1000); //ÁÛËÎ rnd2-140
		signVisual.style.pointerEvents = "auto";
		signVisual.style.stroke = "green";
		
		
		this.svgCont.appendChild(signVisual);
		
		
		//console.log(signVisual);
		
		
		 
		
		signVisual.addEventListener('mouseover', function(){
		if (!cxtConteiner.Editable ){
		console.log(ctx);
		console.log(this);
		 cxtConteiner.BboxToSign(this, ctx);
			}
		});
		
		
		
		signVisual.addEventListener('mouseout', function(){
		
		var b = document.getElementById('bbox');
		console.log(b);
	
		if(b!=null && !cxtConteiner.Editable){b.remove(); console.log("ÌÛØÜ ÂûøËÀ->Ñíÿëè âûäåëåíèå");} 
		});
		
		
		
		
		signVisual.addEventListener('click',   function(e){
				
		cxtConteiner.EditPointSign(e, sign)				
		
		 });
		
		
		
		
		document.onmousemove = function (e){
		cxtConteiner.Editable=true;
		
		
		signVisual.setAttribute('x', e.offsetX + xSmechenie); //ÁÛËÎ rnd
		signVisual.setAttribute('y',e.offsetY + ySmechenie); //ÁÛËÎ rnd2-140
		
		document.onclick = function(){ 
		cxtConteiner.Editable=false;
		
		
		var signGeoCoord = cxtConteiner.PointSignToGeo([e.offsetX, e.offsetY]); //VSE NE PRAVILNO
		//console.log(d);
		
		sign.setX(signGeoCoord[0]);
		sign.setY(signGeoCoord[1]);
		
		SignArray.setElement(sign);
		
		sign.signDom = signVisual;
		  
					
		
		//signVisual.getBBox();
	
		
			
	
		
		
		
		document.onmousemove = null; document.onmousemove = null; document.onclick = null;}	
		
		

		}
		
			return signVisual;
			
			
		
			
			
			
			}












    this.setLineSignWithStorage = function(sign){

var ctx = this;
		console.log(sign);
        var svgNS = this.svgCont.namespaceURI;
		//console.log(sign);
		var signVisual = document.createElementNS('http://www.w3.org/2000/svg','line');
		signVisual.style.pointerEvents = "auto";
		signVisual.style.stroke = "red";
		signVisual.style.strokeWidth =3; 
			
			
			
			
		var coords = map.getPixelFromCoordinate([sign.x1, sign.y1]);
		var coordX1 = coords[0];
		var coordY1 = coords[1];
		var coords2 = map.getPixelFromCoordinate([sign.x1, sign.y1]);		
		var coordX2 = coords[0];
		var coordY2 = coords[1];
		

		signVisual.setAttribute('x1', coordX1); //ÁÛËÎ rnd
		signVisual.setAttribute('y1', coordY1); //ÁÛËÎ rnd2-140	
		signVisual.setAttribute('x2', coordX2); //ÁÛËÎ rnd
		signVisual.setAttribute('y2', coordY2); //ÁÛËÎ rnd2-140
		
		
		
		ctx.svgCont.appendChild(signVisual);
					
			
					
			
			SignArray.setElement(sign);
			sign.signDom = signVisual;
			
			console.log(SignArray.ArraySignPosition);
			
			
					
								


}




























     this.setLineSign = function(sign){

var ctx = this;
		console.log(sign);
        var svgNS = this.svgCont.namespaceURI;
		//console.log(sign);
		var signVisual = document.createElementNS('http://www.w3.org/2000/svg','line');
		signVisual.style.pointerEvents = "auto";
		signVisual.style.stroke = "red";
		signVisual.style.strokeWidth =3; 
			
document.onclick = function(e){
	document.onclick = function(e){
		signVisual.setAttribute('x1', e.offsetX); //ÁÛËÎ rnd
		signVisual.setAttribute('y1',e.offsetY); //ÁÛËÎ rnd2-140	
		signVisual.setAttribute('x2', e.offsetX); //ÁÛËÎ rnd
		signVisual.setAttribute('y2',e.offsetY); //ÁÛËÎ rnd2-140
		var signGeoCoord = cxtConteiner.PointSignToGeo([e.offsetX, e.offsetY]);
			sign.setX1(signGeoCoord[0]);
			sign.setY1(signGeoCoord[1]);
		ctx.svgCont.appendChild(signVisual);
			
		document.onmousemove= function(e){
			console.log("ïîøëî äåëî");
			signVisual.setAttribute('x2', e.offsetX);
			signVisual.setAttribute('y2',e.offsetY);
			document.onclick =function(){ 
			var signGeoCoord = cxtConteiner.PointSignToGeo([e.offsetX, e.offsetY]);
			
			
			
			SignArray.setElement(sign);
			sign.signDom = signVisual;
			
			console.log(SignArray.ArraySignPosition);
			document.onmousemove = null; document.onclick=null;
			
			sign.x2 = signGeoCoord[0];
			sign.y2 = signGeoCoord[1];
			
			console.log(sign.x1 +" "+sign.y1 +" "+sign.x2 +" "+ sign.y2);
			}
										 }
		
									}
		
								}


}


	

	this.PointSignToGeo = function(pixelArray){
	//console.log(pixeltocoord);
	return map.getCoordinateFromPixel(pixelArray);
	
	
	
	
	}
	
	this.GeoToPointSign = function(sign){
	
	var pixeltocoord = map.getCoordinateFromPixel([sign.x, sign.y]);
	console.log(pixeltocoord);
	return map.getPixelFromCoordinate([sign.x, sign.y]);
	
	}
	
	this.GeoToLineSign = function(sign){
	console.log("------------------------------------------------------------");
	console.log(sign);
	console.log("------------------------------------------------------------");
	console.log(sign.x1 +" "+ sign.y1);
	var pixeltocoord1 = map.getPixelFromCoordinate([sign.x1, sign.y1]);
	var pixeltocoord2 = map.getPixelFromCoordinate([sign.x2, sign.y2]);
	
		return [pixeltocoord1,pixeltocoord2]
	
	}




}


function LineSign(classCode, color, x1,y1,x2,y2){
this.classCode = classCode;
	this.signDom = null;
	this.type = "LineSign";
	this.color = color;
	this.x1 = x1 || null;
	this.y1 = y1 || null;
	this.x2 = x2 || null;
	this.y2 = y2 || null;
	
	
this.getDom = function() {		//????????? ??????? ? DOM
		return this.signDom;
							 }
	
	this.setX1 = function(x) {		//????????? ??????? ? DOM
		this.x1 = x;
		}
	this.setY1 = function(y) {		//????????? ??????? ? DOM
		this.y1 = y;
							 }
							 
	this.setX2 = function(x) {		//????????? ??????? ? DOM
		this.x2 = x;
		}
	this.setY2 = function(y) {		//????????? ??????? ? DOM
		this.y2 = y;
							 }
	changeColor = function(color){
		this.color = color ;
								 }	
	
}


function PointSign(classCode, color, x, y, rotate){
	
this.classCode = classCode;
this.type = "PointSign";
	this.signDom = null;
	this.color = color ;
	this.x = x || null;
	this.y = y || null;
	this.rotate = rotate || 0;
		
	
	this.getDom = function() {		//????????? ??????? ? DOM
		return this.signDom;
							 }
	
	this.setX = function(x) {		//????????? ??????? ? DOM
		this.x = x;
		}
	this.setY = function(y) {		//????????? ??????? ? DOM
		this.y = y;
							 }
	changeColor = function(color){
		this.color = color ;
								 }
									
										
									
									
									
									}




function SignConteiner(){
 this.ArraySignPosition = new Array();

	this.setElement = function(sign)
	{
	this.ArraySignPosition.push(sign);
	
	}
	this.getElements = function()
	{
		return this.ArraySignPosition;
	
	}	
	
}

var Conteiner = new svgConteiner(1200,900, "layerone");
var Conteiner2 = new svgConteiner(1200,900, "layertwo");
var Conteiner3 = new svgConteiner(1200,900, "layerthree");
var SignArray = new SignConteiner();
var Lline = new LineSign("proba", "green");

function serialize(){


  localStorage.clear();
  
for (var i=0; i<SignArray.ArraySignPosition.length; i++){  

console.log(SignArray.ArraySignPosition[i]);
var serialObj = JSON.stringify(SignArray.ArraySignPosition[i]); //сериализуем его
console.log(serialObj);
localStorage.setItem("id"+i,serialObj); //запишем его в хранилище по ключу "myKey"
}

}


function ParseJson() {


for (var key in localStorage){
if (localStorage.getItem(key) != null && typeof localStorage.getItem(key) !== 'undefined'){


var returnObj = JSON.parse(localStorage.getItem(key))
console.log(returnObj);
if (returnObj.type == "PointSign"){
var ppointSign = new PointSign(returnObj.classCode, returnObj.color, returnObj.x, returnObj.y, returnObj.rotate)
SignArray.ArraySignPosition.push(ppointSign);
Conteiner.setPointSignWithStorage(ppointSign);
}

if (returnObj.type == "LineSign"){
var llineSign = new LineSign(returnObj.classCode, returnObj.color, returnObj.x1, returnObj.y1, returnObj.x2, returnObj.y2);
SignArray.ArraySignPosition.push(llineSign);
Conteiner.setLineSignWithStorage(llineSign);
}

}
}

}




map.on('precompose', function(){



 Conteiner.UpdateConteiner();
 
 

});

//map.on('moveend', function(){getSignSymbols();})

map.getView().on('change:resolution', function(){var zoom = map.getView().getZoom(); if (Number.isInteger(zoom)){ getSignSymbols(); Conteiner.sizeUpdate2(); }})

//map.getView().on('change:resolution')



//document.on('click', function(){alert("sad")});

</script>

