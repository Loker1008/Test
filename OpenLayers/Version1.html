<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8">
       <style>
	   
	   body {
	   margin: 2px;
	   padding: 2px;
	   overflow: hidden;
	   }
	   .header {
	   display:block;
	   width:100%;
	   height:70px;
	   border: 1px solid;
	   background-color: #f1f0f0;
	   }
	   
	   .logo{
	   position:relative;
	   left:43%;
	   }
	   
	   
	   .center{
	   width:79.7%;
	   float:left;
	   }
	   .left {
	   background-color:#f1f0f0;
	   border:1px solid;
	   overflow:hidden;
	   height:900px;
	   width: 10%;
	   display:block;
	   float:left;
	   }
	   
	   .right {overflow:hidden;
	    background-color:#f1f0f0;
	   border:1px solid;
	   height:900px;
	   	   width: 10%;
	   display:block;
	   float:left;
	   }
      	 .map {
        height: 900px;
        width: 100%;
      }
	.svg {
		position:absolute;
		top:75px;
		    left: 200px;
        pointer-events:none;
	}
	.scales {
	display:block;
	}
	
	
	#symbols {
	    transform : scale(0.7);
		display : none;
					}
					
	.signBeyz{
	display:block;
	}
	
	#logo_text{
	height: 70px;
    line-height: 22px;
    font-size: 25px;
	}
		
.signSymbol{
transform: "scale (1.5,1.5)";
}     	

.pointSign{
}

.leftToolBar{
position:absolute;
left:20px;
top:20px;
mergin: 10px;
}

.leftTool{
    border: 2px solid;
    border-radius: 5px;
cursor:pointer;
color: #989898;
margin:7px;
}

.rightToolBar{
position:absolute;
right:20px;
top:20px;
mergin: 10px;
}
.spanBlock{
display:block;
}

#bbox {
pointer-events:auto;
}

    </style>
<script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
<link rel="stylesheet" href="./font-awesome/css/font-awesome.min.css">

<title>OpenLayers example</title>
  </head>

<body>
<div class = "header">
<div class = "leftToolBar">
<i class="leftTool fa fa-user-circle fa-2x" aria-hidden="true" onclick = "alert()"></i>
<i class="leftTool fa fa-address-book-o fa-2x" aria-hidden="true"></i>
<i class="leftTool fa fa-info-circle fa-2x" aria-hidden="true"></i>
</div>



<div class = "logo">
<img src="./glob.png" style="width:70px; float:left;"/>
<div id = "logo_text">
<div>Редактор</div>
<div>Оперативной</div>
<div>Обстановки</div>
</div>
</div>

<div class = "rightToolBar">
<i class="leftTool fa fa-user-circle fa-2x" aria-hidden="true" onclick = "serialize()"></i>
<i class="leftTool fa fa-address-book-o fa-2x" aria-hidden="true" onclick = "ParseJson()"></i>
<i class="leftTool fa fa-info-circle fa-2x" aria-hidden="true"></i>
</div>
</div>
    <div class = "left">
	<span><b>Дерево слоев:</b></span>
<div class = "LayersVisible">	
	<input type="checkbox" id="one" name="scales" onchange="toggleCheckbox(this)"checked>
  <label for="scales">Слой красных</label>
 </div> 
 <div class = "LayersVisible">	
   <input type="checkbox" id="two" name="scales" onchange="toggleCheckbox(this)" checked>
  <label for="scales">Слой зеленых</label> 
  
         
</div>

<div class = "LayersVisible">
<input type="checkbox" id="three" name="scales" onchange="toggleCheckbox(this)" checked >
  <label for="scales">Слой серых</label>
	</div>
	
	
	<span class = "spanBlock" ><b>Дерево Знаков:</b></span>
	<span class = "spanBlock">Морской флот:</span>
	<span class = "spanBlock">Наземные войста:</span>
	<span class = "spanBlock">Инжинерные войска:</span>
	<span class = "spanBlock">Стройбат:</span>
	
	</div> 
	<div class = "center">
		<div id="map" class="map">
		
	</div>
	

	
	<div id="ToolsPanel"></div>

	

	<svg id="symbols">
	
	<symbol class = "signSymbol" id="sign1" stroke="red" pointX="0" pointY="-140">
			
			<line x1="50" y1="75" x2="0" y2="50"  stroke-width="3" typeNode = "line"></line>
			<line x1="0" y1="140" x2="0" y2="50" stroke-width="7" typeNode = "line"></line>
			<line x1="0" y1="100" x2="50" y2="75" stroke-width="3" typeNode = "line"></line>
			
	</symbol>
	
	
	<symbol class = "signSymbol" id="sign2" stroke="blue" pointX="-50" pointY="-140">
			
			<line x1="50" y1="50" x2="0" y2="75" stroke-width="3" typeNode = "line"></line>
			<line x1="50" y1="140" x2="50" y2="50" stroke-width="3" typeNode = "line"></line>
			<line x1="0" y1="75" x2="50" y2="100" stroke-width="3" typeNode = "line"></line>
			
	</symbol>
	
	<symbol class = "signSymbol" id="sign3" stroke="grey" pointX="-50" pointY="-140">
			
			<line x1="150" y1="50" x2="0" y2="75" stroke-width="3" typeNode = "line"></line>
		<line x1="50" y1="140" x2="50" y2="50" stroke-width="3" typeNode = "line"></line>
			<line x1="0" y1="75" x2="50" y2="100" stroke-width="3" typeNode = "line"></line>
			
	</symbol>
	
	
	<!-- <symbol class = "signSymbol" id="sign4" stroke="red" pointX="0" pointY="-140"> -->
			<!-- <circle cx="40" cy="40" stroke="red" typeNode = "circle"></circle> -->
			<!-- <line x1="50" y1="75" x2="0" y2="50"  stroke-width="3" typeNode = "line"></line> -->
			<!-- <line x1="50" y1="75" x2="0" y2="50"  stroke-width="3" typeNode = "line"></line> -->
			<!-- <line x1="50" y1="75" x2="0" y2="50"  stroke-width="3" typeNode = "line"></line> -->
			<!-- <line x1="50" y1="75" x2="0" y2="50"  stroke-width="3" typeNode = "line"></line> -->
			<!-- <line x1="0" y1="140" x2="0" y2="50" stroke-width="7" typeNode = "line"></line> -->
			<!-- <line x1="0" y1="100" x2="50" y2="75" stroke-width="3" typeNode = "line"></line> -->
			
	<!-- </symbol> -->
	
		</svg>
	
	 
	
  </div>
  
  <div class = "right">
  <span><b>Библиотека знаков:</b></span>
  <button class = "signBeyz" id = "button1" onclick="sign1Add()">Красный знак</button>
	<button class = "signBeyz" id = "button2" onclick="sign2Add()">Зеленый знак</button>
	<button class = "signBeyz" id = "button3" onclick="sign3Add()">Серый знак</button>
		<button class = "signBeyz" id = "button4" onclick="sign4Add()">Линия</button>
		<button class = "signBeyz" id = "button5" onclick="Conteiner.setPathSign()"><Бизье</button>
		
		</div>
	</body>


<script>



var createSignSym = createSignSymbols();


function createSignSymbols(){

var PointSymbolsArray=[];

var PointSymbolsArray2=[];




var signSymbols = document.getElementsByClassName("signSymbol");

for (var q=0; q<signSymbols.length; q++){
var signSymbolsAtr = signSymbols[q];

var Obj = {}

	Obj['name'] = signSymbolsAtr.getAttribute('id');
	Obj['pointx'] = signSymbolsAtr.getAttribute('pointx');
	Obj['pointy'] = signSymbolsAtr.getAttribute('pointy');
    
	
var Obj2 = {}

	Obj2['name'] = signSymbolsAtr.getAttribute('id');
	Obj2['pointx'] = signSymbolsAtr.getAttribute('pointx');
	Obj2['pointy'] = signSymbolsAtr.getAttribute('pointy');
    

var signSymbolsAtr = signSymbols[q].children;



for (var j=0; j<signSymbolsAtr.length; j++){
	if (signSymbolsAtr[j].getAttribute("typenode") == "line"){Obj[j] = [signSymbolsAtr[j].attributes.x1.value,signSymbolsAtr[j].attributes.y1.value,signSymbolsAtr[j].attributes.x2.value,signSymbolsAtr[j].attributes.y2.value];}
	console.log(signSymbolsAtr[j].getAttribute("typenode"));

if (signSymbolsAtr[j].getAttribute("typenode") == "line"){
	Obj2[j] = {
	typeNode : signSymbolsAtr[j].getAttribute("typenode"),
	coodsArray : [signSymbolsAtr[j].attributes.x1.value,signSymbolsAtr[j].attributes.y1.value,signSymbolsAtr[j].attributes.x2.value,signSymbolsAtr[j].attributes.y2.value]
	};
	console.log(Obj2[j]);
	}
	
if (signSymbolsAtr[j].getAttribute("typenode") == "circle"){
	Obj2[j] = {
	typeNode : signSymbolsAtr[j].getAttribute("typenode"),
	coodsArray : [signSymbolsAtr[j].attributes.cx.value, signSymbolsAtr[j].attributes.cy.value]
	};
	console.log(Obj2[j]);
	}	


}


PointSymbolsArray.push(Obj);
PointSymbolsArray2.push(Obj2);

console.log(PointSymbolsArray);
console.log(PointSymbolsArray2);
}
return PointSymbolsArray;

}


function getSignSymbols(){


for (var j=0; j<createSignSym.length; j++){
	var editElement = document.getElementById(createSignSym[j]['name']);
	editElement.setAttribute('pointx', createSignSym[j].pointx);
	editElement.setAttribute('pointy', createSignSym[j].pointy);
		for (var q=0; q<editElement.children.length; q++){
			var editNode = editElement.children[q].attributes;
			var valueNode = createSignSym[j][q];
				for (var i=0; i<valueNode.length; i++){
					editNode[i].value = valueNode[i]; 
				}
		}
}


}




function toggleCheckbox(checkBox){
	var layer = document.getElementById("layer" + checkBox.getAttribute('id'));
	if (!checkBox.checked)layer.style.display="none";
	if (checkBox.checked)layer.style.display="";
}

function sign1Add(){
	var t = new PointSign("sign1", "layer1", "red");
	var d = new PointSign("sign1","egd1","layer1", "red", null, null, 0);
	Conteiner.setPointSign(d);
}

function sign2Add(){
	Conteiner2.setPointSign(new PointSign("sign2","egd1", "layer2", "blue", null, null, 0));
}

function sign3Add(){
	Conteiner3.setPointSign(new PointSign("sign4","egd1", "layer2", "blue", null, null, 0));
}

function sign4Add(){
	Conteiner.setLineSign(new LineSign("line1", "black", 3));
}






	var lastFocus = null;

      var map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          })
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([37.41, 8.82]),
          zoom: 5
        })
      });
	var oldEvt=map.focus_;


var AllConteinerEditable = false;
var AllOverBbox = false;

function svgConteiner(width, height, id, egdName){
	var center = document.getElementsByClassName("center");
	var cxtConteiner = this;
	this.resolution = map.getView().getZoom();
	this.width = width;
	this.height = height;
	this.id=id;
	this.Editable = false;
	this.OverBox =false;
	this.egdName = egdName;
	

	this.svgCont = document.createElementNS('http://www.w3.org/2000/svg','svg');
	this.svgCont.setAttribute("width", width+"px");
	this.svgCont.setAttribute("height", height+"px");
	this.svgCont.setAttribute("id",this.id);
	this.svgCont.setAttribute("class","svg");
	center[0].appendChild(this.svgCont);


this.signShiftSymbolDom = function(signSymbol){  //Узнаем смещение знака из DOM

	var signShiftX = signSymbol.getAttribute('pointx');
	var signShiftY = signSymbol.getAttribute('pointy');


return [signShiftX, signShiftY]

}


this.signShift = function(sign){
	var signDomElement = document.getElementById(sign.classCode);
	var	ShiftX = Number(signDomElement.getAttribute("pointx"));
	var	ShiftY = Number(signDomElement.getAttribute("pointy"));
	return {"x": ShiftX, "y": ShiftY}
}




this.sizeUpdate2 = function(){ // Смещение
	var zoom = map.getView().getZoom();
	var symbolCollection = document.getElementsByClassName("signSymbol");
	
	var ExtendArray = {
		0:0.3,
		1:0.3,
		2:0.3,
		3:0.3,
		4:0.4,
		5:0.5,
		6:0.6,
		7:0.7,
		8:0.7,
		9:0.7,
		10:0.7,
		11:0.7,
		12:0.7,
		13:0.7,
		14:0.7,
		15:0.7,
		16:0.7,
		17:0.6,
		18:0.6,
		19:0.6,
		20:0.6,
		21:0.6,
		22:0.6,
		23:0.6,
		24:0.6,
		25:0.6
	}	

	
	for (var i=0; i<symbolCollection.length; i++){
	
	
	if (Number.isInteger(zoom) && Conteiner.resolution){
			
				var signShift = cxtConteiner.signShiftSymbolDom(symbolCollection[i]);
					symbolCollection[i].setAttribute('pointx', signShift[0] * ExtendArray[zoom]);
					symbolCollection[i].setAttribute('pointy', signShift[1] * ExtendArray[zoom]);
				
				var t1 = symbolCollection[i].children;
				var t2 = t1[0].attributes;
					t2[0].value = t2[0].value * ExtendArray[zoom]; 
					t2[1].value = t2[1].value * ExtendArray[zoom]; 
					t2[2].value = t2[2].value * ExtendArray[zoom]; 
					t2[3].value = t2[3].value * ExtendArray[zoom]; 
					var t3 = t1[1].attributes;
					t3[0].value = t3[0].value * ExtendArray[zoom];                 
					t3[1].value = t3[1].value * ExtendArray[zoom]; 
					t3[2].value = t3[2].value * ExtendArray[zoom]; 
					t3[3].value = t3[3].value * ExtendArray[zoom]; 
					var t4 = t1[2].attributes;
					t4[0].value = t4[0].value * ExtendArray[zoom]; 
					t4[1].value = t4[1].value * ExtendArray[zoom]; 
					t4[2].value = t4[2].value * ExtendArray[zoom]; 
					t4[3].value = t4[3].value * ExtendArray[zoom]; 
	}

	}
	Conteiner.resolution=zoom;	
} 




	
this.UpdateConteiner = function(){ // Здесь смещение
	var SignsObjArray = SignArray.ArraySignPosition;
	 for (var i=0; i < SignsObjArray.length;i++){
		if (SignsObjArray[i] instanceof PointSign){
			var zoom = map.getView().getZoom();
			
			var shift = cxtConteiner.signShift(SignsObjArray[i]);
			var signDomCoords = cxtConteiner.GeoToPointSign(SignsObjArray[i]);
			var signDom = SignsObjArray[i].getDom();
			var mx = signDomCoords[0] + shift.x;
			var my = signDomCoords[1] + shift.y;
				signDom.setAttribute("x", mx);
				signDom.setAttribute("y", my);	
					if (SignsObjArray[i] !=0){
						signDom.setAttribute("transform", "translate(" + signDomCoords[0] + "," + signDomCoords[1] + ") rotate("+SignsObjArray[i].rotate+") translate(" + (-signDomCoords[0]) + "," + (-signDomCoords[1]) + ")")};
											}
										
					if (SignsObjArray[i] instanceof LineSign){
						var lineDomCoords = cxtConteiner.GeoToLineSign(SignsObjArray[i]);
						var signDom = SignsObjArray[i].signDom
							signDom.setAttribute("x1", lineDomCoords[0][0]);
							signDom.setAttribute("y1", lineDomCoords[0][1]);	 
							signDom.setAttribute("x2", lineDomCoords[1][0]);
							signDom.setAttribute("y2", lineDomCoords[1][1]);	
					}							
		}
}
	
this.clearALL = function(e){
	var tar = e.target;
		tar = tar.tagName;
		if (AllConteinerEditable && tar != "use")  {
			if(AllOverBbox){
				var bboxVisual = document.getElementById('bbox');
				bboxVisual.remove();} 
				AllOverBbox=false;
				AllConteinerEditable=false;
				document.removeEventListener("click", Conteiner.clearALL, false);
			}
		}
	
this.EditPointSign = function(e, sign){  //Здесб смещение
	
	var signVisual = e.target;
		if (!AllConteinerEditable && AllOverBbox && sign instanceof PointSign)  {
			var bboxVisual = document.getElementById('bbox'); 
			AllOverBbox=true;		
			AllConteinerEditable=true;
			
				signVisual.onmousedown = function(){
					document.onmousemove = function(e){
					
						bboxVisual.style.display="none";


						var shift = cxtConteiner.signShift(sign);

						var signVisualDom = sign.signDom;
						var signX = e.offsetX + shift.x;
						var signY = e.offsetY + shift.y;
							signVisualDom.setAttribute('x', signX);
							signVisualDom.setAttribute('y', signY);
						var signGeoCoords = cxtConteiner.PointSignToGeo([e.offsetX,e.offsetY]);
							if (sign.rotate !=0) {
								sign.getDom().removeAttribute('transform')
								sign.setX(signGeoCoords[0]);
								sign.setY(signGeoCoords[1]);
																 
							  var signDomCoords = cxtConteiner.GeoToPointSign(sign);
							  var signDom = sign.getDom();
							  var mx = signDomCoords[0]+shift.x;
							  var my = signDomCoords[1]+shift.y;
									signDom.setAttribute("transform", "translate(" + signDomCoords[0] + "," + signDomCoords[1] + ") rotate("+sign.rotate+") translate(" + (-signDomCoords[0]) + "," + (-signDomCoords[1]) + ")");
							} else {
								sign.setX(signGeoCoords[0]);
								sign.setY(signGeoCoords[1]);	
							}
					
					}
					document.onmouseup = function(){
						document.onmousemove = null; document.onmouseup = null; signVisual.onmousedown = null;
					}
				}
			document.addEventListener("click", function(e){
				if (e.path[0].nodeName !='circle' ){
					Conteiner.clearALL(e);
				}
			});
		} 
}



this.BboxToSign = function(sign,cxt){
		// POPITKA BBOX
		
		var SignObject = cxt;
		var bbox = sign.getBBox();
		
		//console.log(sign);
//console.log(cxt);
		AllOverBbox=true;
		
		
		
		this.bboxVisible = document.createElementNS('http://www.w3.org/2000/svg','g');
		this.bboxVisible.setAttribute('id', 'bbox'); //ÁÛËÎ rnd
		this.svgCont.appendChild(this.bboxVisible);
		
		
		var scaleSignVisual = document.createElementNS('http://www.w3.org/2000/svg','circle');
		scaleSignVisual.setAttribute('cx', bbox.x +bbox.width +5 ); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('cy', bbox.y-5 ); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('r',3);
        scaleSignVisual.setAttribute('stroke',2);
		this.bboxVisible.appendChild(scaleSignVisual);
		
			var lineVision = document.createElementNS('http://www.w3.org/2000/svg','line');
		lineVision.setAttribute('x1', bbox.x +bbox.width +5); //ÁÛËÎ rnd
		lineVision.setAttribute('y1', bbox.y-5 ); //ÁÛËÎ rnd
		lineVision.setAttribute('x2', bbox.x -5); //ÁÛËÎ rnd
		lineVision.setAttribute('y2', bbox.y-5 ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke','black' ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke-dasharray','4' ); //ÁÛËÎ rnd

		this.bboxVisible.appendChild(lineVision);
		
		var scaleSignVisual = document.createElementNS('http://www.w3.org/2000/svg','circle');
		scaleSignVisual.setAttribute('cx', bbox.x -5); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('cy', bbox.y-5 ); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('r',3);
        scaleSignVisual.setAttribute('stroke',2);
		this.bboxVisible.appendChild(scaleSignVisual);
		
		
		var lineVision = document.createElementNS('http://www.w3.org/2000/svg','line');
		lineVision.setAttribute('x1', bbox.x -5); //ÁÛËÎ rnd
		lineVision.setAttribute('y1', bbox.y+ bbox.height +5); //ÁÛËÎ rnd
		lineVision.setAttribute('x2', bbox.x -5); //ÁÛËÎ rnd
		lineVision.setAttribute('y2', bbox.y-5 ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke','black' ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke-dasharray','4' ); //ÁÛËÎ rnd

		this.bboxVisible.appendChild(lineVision);
		
		
		
		var scaleSignVisual = document.createElementNS('http://www.w3.org/2000/svg','circle');
		scaleSignVisual.setAttribute('cx', bbox.x -5); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('cy', bbox.y + bbox.height+5); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('r',3);
        scaleSignVisual.setAttribute('stroke',2);
		this.bboxVisible.appendChild(scaleSignVisual);
		
		
		
		var lineVision = document.createElementNS('http://www.w3.org/2000/svg','line');
		lineVision.setAttribute('x1', bbox.x-5); //ÁÛËÎ rnd
		lineVision.setAttribute('y1', bbox.y+ bbox.height +5); //ÁÛËÎ rnd
		lineVision.setAttribute('x2', bbox.x +bbox.width+5); //ÁÛËÎ rnd
		lineVision.setAttribute('y2', bbox.y + bbox.height+5 ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke','black' ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke-dasharray','4' ); //ÁÛËÎ rnd

		this.bboxVisible.appendChild(lineVision);
		
		
		
		
		var scaleSignVisual = document.createElementNS('http://www.w3.org/2000/svg','circle');
		scaleSignVisual.setAttribute('cx', bbox.x +bbox.width+5); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('cy', bbox.y + bbox.height+5 ); //ÁÛËÎ rnd
		scaleSignVisual.setAttribute('r',3);
        scaleSignVisual.setAttribute('stroke',2);
		this.bboxVisible.appendChild(scaleSignVisual);
		
				
		var lineVision = document.createElementNS('http://www.w3.org/2000/svg','line');
		lineVision.setAttribute('x1', bbox.x+ bbox.width +5); //ÁÛËÎ rnd
		lineVision.setAttribute('y1', bbox.y); //ÁÛËÎ rnd
		lineVision.setAttribute('x2', bbox.x +bbox.width+5); //ÁÛËÎ rnd
		lineVision.setAttribute('y2', bbox.y + bbox.height+5 ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke','black' ); //ÁÛËÎ rnd
		lineVision.setAttribute('stroke-dasharray','4' ); //ÁÛËÎ rnd
		this.bboxVisible.appendChild(lineVision);
		
		
		
		var rotateCircleX = (bbox.x -5) +bbox.width/2+5;
		var rotateCircleY = bbox.y-20;
		
		
		var rotateSignVisual = document.createElementNS('http://www.w3.org/2000/svg','circle');
		rotateSignVisual.setAttribute('cx', rotateCircleX); //ÁÛËÎ rnd
		rotateSignVisual.setAttribute('cy', rotateCircleY); //ÁÛËÎ rnd
		rotateSignVisual.setAttribute('r',5);
        rotateSignVisual.setAttribute('stroke',2);
		this.bboxVisible.appendChild(rotateSignVisual);
		
		var bboxVis = this.bboxVisible;
		
		
		rotateSignVisual.onmousedown= function(){
		console.log(SignObject);
		//cxtConteiner.Editable = false ; console.log("ROTATE");
		
		document.onmousemove = function(e)
		{
			var rotatePositionX = rotateSignVisual.getAttribute("cx");
			var rotatePositionY = rotateSignVisual.getAttribute("cy");
			var coords = cxtConteiner.GeoToPointSign(SignObject);
			var coordX = coords[0];
			var coordY = coords[1];
		
			var mx = e.offsetX - coordX;
			var my = e.offsetY - coordY;
			var angle = Math.atan2 (my,mx);
				angle = angle *180 / Math.PI;
				angle+=90;
		

        document.onmouseup = function(){
		SignObject.rotate = angle;
	    document.onmousemove = null;
		document.onmouseup = null; 
		}
		
			//console.log(sign);
		
		var RotateAtributes = "translate ("+coords[0]+","+coords[1]+ ") rotate(" + angle+") translate ("+(-coords[0])+","+(-coords[1])+ ")";
		var RotateForcircle = "translate ("+rotateCircleX+","+rotateCircleY+ ") rotate(" + angle+") translate ("+(-rotateCircleX)+","+(-rotateCircleY)+ ")";	
			rotateSignVisual.setAttribute("transform", RotateForcircle);
			sign.setAttribute("transform", RotateAtributes);
			bboxVis.setAttribute("transform", RotateAtributes);
		//console.log(rotateSignVisual);
		}
		
		rotateSignVisual.onmouseup = function(){
		console.log("Editeble TRUE");
		document.onmousemove = null;
		//cxtConteiner.Editable = true;
		}
				
		}
		

		
		
		
		
		var shift = cxtConteiner.signShift(cxt);

	 
	  var signDomCoords = cxtConteiner.GeoToPointSign(cxt);
	  var signDom = this.bboxVisible;
	  var mx = signDomCoords[0]+shift.x;
	  var my = signDomCoords[1]+shift.y;
		
	if (cxt.rotate !=0){ signDom.setAttribute("transform", "translate(" + signDomCoords[0] + "," + signDomCoords[1] + ") rotate("+cxt.rotate+") translate(" + (-signDomCoords[0]) + "," + (-signDomCoords[1]) + ")")};
		
		
		
		
		
		}





	this.setPointSignWithStorage = function(sign){
	
	var ctx = sign;
	var Smechenie = document.getElementById(sign.classCode);
			xSmechenie = Number(Smechenie.getAttribute("pointx"));
			ySmechenie = Number(Smechenie.getAttribute("pointy"));
		//console.log(xSmechenie +" "+ySmechenie);
	
		
		
		
		var coords = cxtConteiner.GeoToPointSign(sign);
		var coordX = coords[0];
		var coordY = coords[1];
		
		var svgNS = this.svgCont.namespaceURI;
		
		var signVisual = document.createElementNS('http://www.w3.org/2000/svg','use');
		signVisual.setAttribute('class','pointSign');
		signVisual.setAttribute('href', '#'+ sign.classCode);
		signVisual.setAttribute('x', coordX+xSmechenie); //ÁÛËÎ rnd
		signVisual.setAttribute('y',coordY + ySmechenie); //ÁÛËÎ rnd2-140
		signVisual.style.pointerEvents = "auto";
		signVisual.style.stroke = "green";
		
		
		this.svgCont.appendChild(signVisual);
		sign.signDom = signVisual;
		
		
		
		
		
		
		signVisual.addEventListener('mouseover', function(){
			if (!AllConteinerEditable ){
				Conteiner.BboxToSign(this, ctx);
			}
		});
		
		
		
		signVisual.addEventListener('mouseout', function(){
			var b = document.getElementById('bbox');
				if(b!=null && !AllConteinerEditable){b.remove(); } 
		});
		
		
		
		
		signVisual.addEventListener('click',   function(e){
				
		Conteiner.EditPointSign(e, sign)				
		
		 });
		
	
		

		
			return signVisual;
			
			
		
			
			
			
			}




	this.setPointSign = function(sign){           //ЗДЕСЬ СМЕЩЕНИЕ
	
	var ctx = sign;
	
	
	var shift = cxtConteiner.signShift(sign);
	
		var svgNS = this.svgCont.namespaceURI;
		var signVisual = document.createElementNS('http://www.w3.org/2000/svg','use');
		signVisual.setAttribute('class','pointSign');
		signVisual.setAttribute('href', '#'+ sign.classCode);
		signVisual.setAttribute('x', 1000); //ÁÛËÎ rnd
		signVisual.setAttribute('y',1000); //ÁÛËÎ rnd2-140
		signVisual.style.pointerEvents = "auto";
		signVisual.style.stroke = "green";
		
		
		this.svgCont.appendChild(signVisual);
		
		
		
		
		 
		
		signVisual.addEventListener('mouseover', function(){
		if (!AllConteinerEditable){
		
		 cxtConteiner.BboxToSign(this, ctx);
			}
		});
		
		
		
		signVisual.addEventListener('mouseout', function(){
		
		var b = document.getElementById('bbox');
			
		if(b!=null && !AllConteinerEditable){b.remove(); } 
		});
		
		
		
		
		
		signVisual.addEventListener('click',   function(e){
	    if (!AllOverBbox) Conteiner.BboxToSign(this, ctx);	
		
		Conteiner.EditPointSign(e, sign)				
		
		 });
		
		
		
		
		document.onmousemove = function (e){
		AllConteinerEditable=true;
		
		
		signVisual.setAttribute('x', e.offsetX + shift.x); //ÁÛËÎ rnd
		signVisual.setAttribute('y',e.offsetY + shift.y); //ÁÛËÎ rnd2-140
		
		document.onclick = function(){ 
		AllConteinerEditable=false;
		
		
		var signGeoCoord = cxtConteiner.PointSignToGeo([e.offsetX, e.offsetY]); //VSE NE PRAVILNO
		
		
		sign.setX(signGeoCoord[0]);
		sign.setY(signGeoCoord[1]);
		
		SignArray.setElement(sign);
		
		sign.signDom = signVisual;
		  
					
		
		//signVisual.getBBox();
	
		
			
	
		
		
		
		document.onmousemove = null; document.onmousemove = null; document.onclick = null;}	
		
		

		}
		
			return signVisual;
			
			
		
			
			
			
			}

    this.setLineSignWithStorage = function(sign){

var ctx = this;
		var svgNS = this.svgCont.namespaceURI;
		
		var signVisual = document.createElementNS('http://www.w3.org/2000/svg','line');
		signVisual.style.pointerEvents = "auto";
		signVisual.style.stroke = sign.color;
		signVisual.style.strokeWidth =sign.stroke; 
			
			
			
			
		var coords = map.getPixelFromCoordinate([sign.x1, sign.y1]);
		var coordX1 = coords[0];
		var coordY1 = coords[1];
		var coords2 = map.getPixelFromCoordinate([sign.x1, sign.y1]);		
		var coordX2 = coords[0];
		var coordY2 = coords[1];
		

		signVisual.setAttribute('x1', coordX1); //ÁÛËÎ rnd
		signVisual.setAttribute('y1', coordY1); //ÁÛËÎ rnd2-140	
		signVisual.setAttribute('x2', coordX2); //ÁÛËÎ rnd
		signVisual.setAttribute('y2', coordY2); //ÁÛËÎ rnd2-140
		
		
		
		ctx.svgCont.appendChild(signVisual);
					
			
					
			
			SignArray.setElement(sign);
			sign.signDom = signVisual;
			
			
			
			
					
								


}


     this.setLineSign = function(sign){

var ctx = this;
		console.log(sign);
        var svgNS = this.svgCont.namespaceURI;
		
		var signVisual = document.createElementNS('http://www.w3.org/2000/svg','line');
		signVisual.style.pointerEvents = "auto";
		signVisual.style.stroke = sign.color;
		signVisual.style.strokeWidth =sign.stroke; 
			
document.onclick = function(e){
	document.onclick = function(e){
		signVisual.setAttribute('x1', e.offsetX); //ÁÛËÎ rnd
		signVisual.setAttribute('y1',e.offsetY); //ÁÛËÎ rnd2-140	
		signVisual.setAttribute('x2', e.offsetX); //ÁÛËÎ rnd
		signVisual.setAttribute('y2',e.offsetY); //ÁÛËÎ rnd2-140
		var signGeoCoord = cxtConteiner.PointSignToGeo([e.offsetX, e.offsetY]);
			sign.setX1(signGeoCoord[0]);
			sign.setY1(signGeoCoord[1]);
		ctx.svgCont.appendChild(signVisual);
			
		document.onmousemove= function(e){
			console.log("ïîøëî äåëî");
			signVisual.setAttribute('x2', e.offsetX);
			signVisual.setAttribute('y2',e.offsetY);
			document.onclick =function(){ 
			var signGeoCoord = cxtConteiner.PointSignToGeo([e.offsetX, e.offsetY]);
			
			
			
			SignArray.setElement(sign);
			sign.signDom = signVisual;
			
			console.log(SignArray.ArraySignPosition);
			document.onmousemove = null; document.onclick=null;
			
			sign.x2 = signGeoCoord[0];
			sign.y2 = signGeoCoord[1];
			
			console.log(sign.x1 +" "+sign.y1 +" "+sign.x2 +" "+ sign.y2);
			}
										 }
		
									}
		
								}


}


	this.setPathSign = function(){
		var ctx = this;
		//console.log(sign);
        var svgNS = this.svgCont.namespaceURI;
		
		var signVisual = document.createElementNS('http://www.w3.org/2000/svg','path');
		signVisual.style.pointerEvents = "none";
		//signVisual.style.stroke = sign.color;
		//signVisual.style.strokeWidth =sign.stroke; 

	
	
this.setNextPoints = function(){


}	
	
	document.onclick = function(e){
	document.onclick = function(e){

signVisual.setAttribute('stroke', "black"); //ÁÛËÎ rnd
signVisual.setAttribute('stroke-width', "3px"); //ÁÛËÎ rnd		
signVisual.setAttribute('fill-opacity', "0.3"); //ÁÛËÎ rnd	

		var firstPartPath =  "M " + e.offsetX+" " + e.offsetY ;
		var QPart1 = e.offsetX;
		var QPart2 = e.offsetY;
		var QPArt = " Q "+QPart1+" "+QPart2+ " ";
		var secondPartPath = e.offsetX+" " + e.offsetY;
		var path = firstPartPath + QPArt+ secondPartPath;
		signVisual.setAttribute("d", path);
		//signVisual.setAttribute("fill","transparent");
		
		ctx.svgCont.appendChild(signVisual);
		
var i =false;		
		var test = signVisual.getAttribute("d");
		
		document.onmousemove= function(e){
		
		
		if (i != true){
		
		secondPartPath = e.offsetX+" " + e.offsetY;
		path = firstPartPath +QPArt +secondPartPath;
		 var t = path;
		signVisual.setAttribute("d", t);
			console.log(i);
			
			document.onkeydown = function(e){
			
			
				console.log(e);
				if (e.keyCode == 27){
				document.onmousemove = null; document.onclick = null; document.onkeydown = null;
				signVisual.setAttribute("d", path+"Z");
				}
			}
			
			}
		if( i !=false){
	    var t = path + " Q "+e.offsetX+" "+e.offsetY+ " " +e.offsetX+" " +e.offsetY;
		//path = signVisual.getAttribute("d") +QPArt +e.offsetX+" " +e.offsetY;
		console.log(test);
	console.log(t);
		signVisual.setAttribute("d", t);
		}	
			
			
			
			document.onclick =function(){ 
			
		console.log(path);
		if (i != false){
			var QPart1 = e.offsetX;
		var QPart2 = e.offsetY;
		var QPArt = " Q "+QPart1+" "+QPart2+ " ";
		path += QPArt+ e.offsetX +" "+e.offsetY;
		
		console.log(path);
		signVisual.setAttribute("d", path);
		//document.onmousemove = null; //document.onclick=null;
			
}	
i=true;	
		}
										 }
		
									}
		
								}
	
	
	}
	

	this.PointSignToGeo = function(pixelArray){
	//console.log(pixeltocoord);
	return map.getCoordinateFromPixel(pixelArray);
	
	
	
	
	}
	
	this.GeoToPointSign = function(sign){
	
	var pixeltocoord = map.getCoordinateFromPixel([sign.x, sign.y]);
	return map.getPixelFromCoordinate([sign.x, sign.y]);
	
	}
	
	this.GeoToLineSign = function(sign){
		var pixeltocoord1 = map.getPixelFromCoordinate([sign.x1, sign.y1]);
		var pixeltocoord2 = map.getPixelFromCoordinate([sign.x2, sign.y2]);
	
		return [pixeltocoord1,pixeltocoord2]
	
	}




}


function LineSign(classCode, color, stroke, x1,y1,x2,y2){
this.classCode = classCode;
	this.signDom = null;
	this.type = "LineSign";
	this.color = color || red;
	this.stroke = stroke || 3;
	this.x1 = x1 || null;
	this.y1 = y1 || null;
	this.x2 = x2 || null;
	this.y2 = y2 || null;
	this.layer = null;
	
	
this.getDom = function() {		//????????? ??????? ? DOM
		return this.signDom;
							 }
	
	this.setX1 = function(x) {		//????????? ??????? ? DOM
		this.x1 = x;
		}
	this.setY1 = function(y) {		//????????? ??????? ? DOM
		this.y1 = y;
							 }
							 
	this.setX2 = function(x) {		//????????? ??????? ? DOM
		this.x2 = x;
		}
	this.setY2 = function(y) {		//????????? ??????? ? DOM
		this.y2 = y;
							 }
	changeColor = function(color){
		this.color = color ;
								 }	
	
}


function PointSign(classCode, egdName, layer, color, x, y, rotate){
	
this.classCode = classCode;
this.type = "PointSign";
	this.egdName = egdName || null;
	this.signDom = null;
	this.layer = layer || 1;
	this.color = color ;
	this.x = x || null;
	this.y = y || null;
	this.rotate = rotate || 0;
	
		
	
	this.getDom = function() {		//????????? ??????? ? DOM
		return this.signDom;
							 }
	
	this.setX = function(x) {		//????????? ??????? ? DOM
		this.x = x;
		}
	this.setY = function(y) {		//????????? ??????? ? DOM
		this.y = y;
							 }
	changeColor = function(color){
		this.color = color ;
								 }
									
										
									
									
									
									}


function PathSign(classCode, color){



}


function SignConteiner(){
 this.ArraySignPosition = new Array();

	this.setElement = function(sign)
	{
	this.ArraySignPosition.push(sign);
	
	}
	this.getElements = function()
	{
		return this.ArraySignPosition;
	
	}	
	
}

var Conteiner = new svgConteiner(1200,900, "layerone", "egd1");
var Conteiner2 = new svgConteiner(1200,900, "layertwo", "egd2");
var Conteiner3 = new svgConteiner(1200,900, "layerthree", "egd3");
var SignArray = new SignConteiner();
var Lline = new LineSign("proba", "green");

function serialize(){


  localStorage.clear();
  
for (var i=0; i<SignArray.ArraySignPosition.length; i++){  

console.log(SignArray.ArraySignPosition[i]);
var serialObj = JSON.stringify(SignArray.ArraySignPosition[i]); //сериализуем его
console.log(serialObj);
localStorage.setItem("id"+i,serialObj); //запишем его в хранилище по ключу "myKey"
}

}


function ParseJson() {


for (var key in localStorage){
if (localStorage.getItem(key) != null && typeof localStorage.getItem(key) !== 'undefined'){


var returnObj = JSON.parse(localStorage.getItem(key))
if (returnObj.type == "PointSign"){
var ppointSign = new PointSign(returnObj.classCode, returnObj.egdName, returnObj.layer,returnObj.color, returnObj.x, returnObj.y, returnObj.rotate)
SignArray.ArraySignPosition.push(ppointSign);

if (returnObj.layer == "layer1") Conteiner.setPointSignWithStorage(ppointSign);
if (returnObj.layer == "layer2") Conteiner2.setPointSignWithStorage(ppointSign);
}

if (returnObj.type == "LineSign"){
var llineSign = new LineSign(returnObj.classCode, returnObj.color, returnObj.stroke, returnObj.x1, returnObj.y1, returnObj.x2, returnObj.y2);
SignArray.ArraySignPosition.push(llineSign);
Conteiner.setLineSignWithStorage(llineSign);
}

}
}

}




map.on('precompose', function(){



 Conteiner.UpdateConteiner();
 
 

});

//map.on('moveend', function(){getSignSymbols();})

map.getView().on('change:resolution', function(){var zoom = map.getView().getZoom(); if (Number.isInteger(zoom)){ getSignSymbols(); Conteiner.sizeUpdate2(); }})

//map.getView().on('change:resolution')



//document.on('click', function(){alert("sad")});

</script>

